<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 12px;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    select,
    button,
    input {
      font-size: 14px;
      padding: 6px;
    }

    .card {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      margin: 8px 0;
    }

    .muted {
      color: #666;
      font-size: 13px;
    }

    button {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <h3>Discover Flexit Nordic</h3>
  <div class="row">
    <label>Interface:</label>
    <select id="iface"></select>
    <button id="scan">Scan (5s)</button>
    <button id="manual">Manual</button>
  </div>

  <div id="status" class="muted"></div>
  <div id="results"></div>

  <script>
    const ifaceEl = document.getElementById('iface');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');

    document.getElementById('manual').addEventListener('click', () => Homey.showView('manual'));

    async function loadIfaces() {
      const ifaces = await Homey.emit('get_interfaces');
      ifaceEl.innerHTML = '';
      const optAuto = document.createElement('option');
      optAuto.value = 'auto';
      optAuto.textContent = 'Auto (try all)';
      ifaceEl.appendChild(optAuto);

      for (const nic of ifaces) {
        const opt = document.createElement('option');
        opt.value = nic.address;
        opt.textContent = `${nic.name} - ${nic.address}`;
        ifaceEl.appendChild(opt);
      }
    }

    function render(devices) {
      resultsEl.innerHTML = '';
      if (!devices.length) {
        resultsEl.innerHTML = '<div class="muted">No devices found. Try another interface or use Manual.</div>';
        return;
      }

      for (const d of devices) {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <div><b>${d.name}</b> (${d.serial})</div>
            <div class="muted">IP: ${d.ip}  •  BACnet: ${d.bacnetPort}  •  MAC: ${d.mac || '-'}  •  FW: ${d.fw || '-'}</div>
            <div style="margin-top:8px;">
              <button>Add</button>
            </div>
          `;
        div.querySelector('button').addEventListener('click', async () => {
          const baseData = d.deviceTemplate.data;
          const baseSettings = d.deviceTemplate.settings;
          const baseName = d.name; // e.g. "Flexit Nordic S4"

          // Thermostat Device
          const thermostatDev = {
            name: baseName + " Heating",
            data: {
              id: baseData.id + "_thermostat",
              unitId: baseData.id,
              role: "thermostat"
            },
            settings: baseSettings,
            class: "thermostat",
            capabilities: [
              "target_temperature",
              "measure_temperature",
              "measure_temperature.outdoor",
              "measure_temperature.extract",
              "measure_power"
            ]
          };

          // Fan Device
          const fanDev = {
            name: baseName + " Fan",
            data: {
              id: baseData.id + "_fan",
              unitId: baseData.id,
              role: "fan"
            },
            settings: baseSettings,
            class: "fan",
            capabilities: [
              "fan_mode",
              "measure_humidity",
              "measure_motor_rpm",
              "measure_motor_rpm.extract",
              "measure_fan_speed_percent",
              "measure_fan_speed_percent.extract",
              "measure_hepa_filter"
            ]
          };

          try {
            await Homey.createDevice(thermostatDev);
            await Homey.createDevice(fanDev);
            await Homey.done();
          } catch (err) {
            Homey.alert(String(err));
          }
        });
        resultsEl.appendChild(div);
      }
    }

    document.getElementById('scan').addEventListener('click', async () => {
      statusEl.textContent = 'Scanning…';
      resultsEl.innerHTML = '';
      try {
        const interfaceAddress = ifaceEl.value;
        const devices = await Homey.emit('discover', { interfaceAddress });
        render(devices);
        statusEl.textContent = `Found ${devices.length} device(s).`;
      } catch (e) {
        statusEl.textContent = 'Scan failed.';
        Homey.alert(String(e), 'error');
      }
    });

    loadIfaces();
  </script>
</body>

</html>
